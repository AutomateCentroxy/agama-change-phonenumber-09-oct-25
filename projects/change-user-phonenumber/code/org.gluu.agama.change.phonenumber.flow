Flow org.gluu.agama.change.phonenumber
     Basepath ""
     Timeout 900 seconds
     Configs conf
//  Create  variable for UI feedback
uiFeedback = {}
uiFeedback.errorMessage = ""
//  Iterate x times max
Repeat 6 times max
     //  Retrieve user profile  from UI
     searchUserInput = RRF "searchUser.ftlh" uiFeedback
     // When searchUserForm is submitted
     When searchUserInput.formType is "searchUserForm"
          // Validate access token first
          accessToken = searchUserInput.access_token
          // accessToken
          Log "@info Validating access token: %" accessToken
          // Create an instance of Update service
          PhonenumberUpdateService = Call org.gluu.agama.change.users.UserphoneUpdate#getInstance 
          // Validate the bearer token
          authCheck = Call org.gluu.agama.change.smschange.PhonenumberUpdate#validateBearerToken accessToken
          // Check if token validation failed
          When authCheck.valid is false
               // CHANGED: Instead of Finish, set error message and continue loop
               uiFeedback.errorMessage = authCheck.errorMessage
          Otherwise
               // Token is valid, proceed with user search
               Log "@info Token validation successful for user: %" authCheck.username
               // Assign username to a variable
               userName = searchUserInput.uid
               // get user by username
               userWithUid = Call PhonenumberUpdateService getUserEntityByUsername userName
               // when user with provided username not found
               When userWithUid.empty is true
               Otherwise
                    RRF "__________" 
//  Maximum attempt reached
Log "@info Maximum attempt reached"
//  User Registration flow failed
it_hmdsb = {success:false, error: "User update flow reached max attempts try later"}
Finish it_hmdsb